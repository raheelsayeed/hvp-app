{% extends 'base.html' %}
{% block content %}
<script>
window.onload = function () {
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function (position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;

            // Fetch reverse geocode
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(data => {
                    const address = data.address;
                    if (address) {
                        document.getElementById('country').value = address.country || "";
                        document.getElementById('city').value = address.city || address.town || address.village || "";
                    }
                })
                .catch(err => console.error("Geo lookup failed", err));
        });
    }
};
</script>
<div class="content-panel">

    <h2>Complete Your Profile</h2>
    <p>Please fill in the following information before continuing to your survey.</p>

    <form method="POST">
        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">
        <table class="form-table">
            <tr>
                <td><label for="age">Age</label></td>
                <td><input type="number" name="age" id="age" required min="18" max="100"></td>
            </tr>
            <tr>
                <td><label for="gender">Gender</label></td>
                <td>
                    <select name="gender" id="gender" required>
                        <option value="">-- Select Gender --</option>
                        <option value="Female">Female</option>
                        <option value="Male">Male</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="race_ethnicity">Race/Ethnicity</label></td>
                <td>
                    <select name="race_ethnicity" id="race_ethnicity" required>
                        <option value="">-- Select Race/Ethnicity --</option>
                        <option value="Asian">Asian</option>
                        <option value="Black or African American">Black or African American</option>
                        <option value="Hispanic or Latino">Hispanic or Latino</option>
                        <option value="White">White</option>
                        <option value="Other">Other</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="country">Country</label></td>
                <td>
                    <select name="country" id="country" required>
                        <option value="">-- Select Country --</option>
                        <option value="India">India</option>
                        <option value="Israel">Israel</option>
                        <option value="United States">United States</option>                        
                        <option value="Other">Other</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="city">City</label></td>
                <td>
                    <input type="text" name="city" id="city" required>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <input type="hidden" name="latitude" id="latitude">
                    <input type="hidden" name="longitude" id="longitude">
                </td>
            </tr>
            <tr>
                <td><label for="is_provider">Are you a healthcare provider?</label></td>
                <td>
                    <select name="is_provider" id="is_provider" required onchange="toggleProviderField(this.value)">
                        <option value="">-- Select Option --</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </td>
            </tr>
            <tr id="provider_type_block" style="display: none;">
                <td><label for="provider_type">Provider Type</label></td>
                <td>
                    <select name="provider_type" id="provider_type" onchange="toggleFieldDropdown()">
                        <option value="">-- Select Type --</option>
                        <option value="Doctor">Doctor</option>
                        <option value="Nurse Practitioner">Nurse Practitioner</option>
                        <option value="Physician Assistant">Physician Assistant</option>
                        <option value="Other">Other</option>
                    </select>
                </td>
            </tr>
            <tr id="field-row" style="display: none;">
                <td><label for="field">Field</label></td>
                <td>
                    <select name="field" id="field">
                        <option value="">-- Select Field --</option>
                        <option value="Primary / Outpatient care">Primary / Outpatient care</option>
                        <option value="Internist / Hospitalist">Internist / Hospitalist</option>
                        <option value="Specialist">Specialist</option>
                    </select>
                </td>
            </tr>
            <tr id="practice-context-row" style="display: none;">
                <td><label for="practice-context">Context</label></td>
                <td>
                    <select name="practice-context" id="practice-context">
                        <option value="">-- Select Context --</option>
                        <option value="urban">Urban</option>
                        <option value="rural">Rural</option>
                        <option value="suburban">Suburban</option>
                        <option value="remote">Mostly Remote (online)</option>
                    </select>
                </td>
            </tr>
        </table>

        <div style="text-align: center; margin-top: 1.5rem;">
            <button type="submit" class="btn primary">Submit</button>
        </div>
    </form>
</div>

<script>
function toggleProviderField(value) {
    const block = document.getElementById('provider_type_block');
    block.style.display = (value === 'yes') ? 'table-row' : 'none';
}
function toggleFieldDropdown() {
    const provider_type = document.getElementById("provider_type").value;
    const fieldRow = document.getElementById("field-row");
    const practicecontext = document.getElementById("practice-context-row");
    fieldRow.style.display = (provider_type === "Doctor") ? "table-row" : "none";
    practicecontext.style.display = (provider_type === "Doctor") ? "table-row" : "none";
}
</script>

<style>
.form-table {
    width: 100%;
    border-spacing: 0 1rem;
}
.form-table td {
    vertical-align: top;
    padding: 0.25rem 0.5rem;
}
.form-table label {
    font-weight: bold;
}
.form-table select, 
.form-table input {
    width: 100%;
    padding: 0.4rem;
    border-radius: 4px;
    border: 1px solid #ccc;
}
</style>

{% endblock %}